<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«ä¹ - æ†¨é¥±é¥±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: #0A1628;
            color: #fff;
            overflow: hidden;
            min-height: 100vh;
            touch-action: manipulation;
        }

        /* åŠ è½½é¡µé¢ */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s ease;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 2px solid transparent;
            border-top: 2px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-text {
            margin-top: 20px;
            color: #FF6B35;
            font-size: 14px;
            letter-spacing: 3px;
        }

        /* åœºæ™¯å®¹å™¨ */
        .scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }

        .scene.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* ç«èŠ±ç²’å­ */
        #spark-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        /* çƒŸèŠ±ç”»å¸ƒ */
        #firework-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        /* åœºæ™¯æ–‡å­— */
        .scene-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: clamp(24px, 6vw, 48px);
            text-align: center;
            z-index: 10;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
            opacity: 0;
            animation: fadeInText 2s ease forwards;
        }

        @keyframes fadeInText {
            to { opacity: 1; }
        }

        .scene-subtext {
            font-size: clamp(16px, 4vw, 24px);
            color: #fceea7;
            margin-top: 20px;
            opacity: 0;
            animation: fadeInText 2s ease 1s forwards;
        }

        /* ç«èŠ±å…ƒç´  */
        .spark {
            width: 30px;
            height: 40px;
            background: radial-gradient(ellipse at center, #FF6B35 0%, #ff4500 50%, transparent 70%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            filter: blur(1px);
            animation: flicker 0.5s ease-in-out infinite alternate;
            z-index: 5;
        }

        @keyframes flicker {
            0% { transform: scale(1) rotate(-3deg); opacity: 0.8; }
            100% { transform: scale(1.1) rotate(3deg); opacity: 1; }
        }

        /* è›‹ç³•åœºæ™¯ */
        #cake-scene {
            background: linear-gradient(to bottom, #0A1628 0%, #1a2a4a 100%);
        }

        .cake-container {
            position: relative;
            width: 90%;
            max-width: 500px;
            height: 60vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            z-index: 10;
        }

        /* è›‹ç³•æ ·å¼ */
        .cake {
            position: relative;
            width: 280px;
            height: 200px;
        }

        .cake-layer {
            position: absolute;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .cake-layer-1 {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            height: 80px;
            background: linear-gradient(to bottom, #FFB6C1 0%, #FF69B4 100%);
        }

        .cake-layer-2 {
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 70px;
            background: linear-gradient(to bottom, #FFF8DC 0%, #FFE4B5 100%);
        }

        .cake-layer-3 {
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 60px;
            background: linear-gradient(to bottom, #E6E6FA 0%, #DDA0DD 100%);
        }

        /* èœ¡çƒ›ç…§ç‰‡ */
        .candle-photos {
            position: absolute;
            top: -180px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 200px;
        }

        .photo-candle {
            position: absolute;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20;
        }

        .photo-candle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .photo-candle .flame {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 20px;
            background: radial-gradient(ellipse at bottom, #FF6B35 0%, #ff4500 40%, transparent 70%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: candleFlicker 0.3s ease-in-out infinite alternate;
        }

        .photo-candle.blown .flame {
            opacity: 0;
            transform: translateX(-50%) scale(0);
        }

        @keyframes candleFlicker {
            0% { transform: translateX(-50%) scale(1) rotate(-5deg); }
            100% { transform: translateX(-50%) scale(1.2) rotate(5deg); }
        }

        .photo-candle:hover {
            transform: scale(1.1);
            z-index: 100;
        }

        /* ç…§ç‰‡æ”¾å¤§æŸ¥çœ‹ */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .photo-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(255, 107, 53, 0.3);
        }

        .photo-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* å¹èœ¡çƒ›æç¤º */
        .blow-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #fceea7;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* è´ºå¡åœºæ™¯ */
        #card-scene {
            background: linear-gradient(135deg, #FFF8F0 0%, #FFE4C4 100%);
        }

        .greeting-card {
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
            transform: scale(0.8);
            opacity: 0;
            animation: cardAppear 1s ease forwards;
        }

        @keyframes cardAppear {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .greeting-card .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #FF6B35;
            margin-bottom: 20px;
        }

        .greeting-card h2 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 36px;
            color: #FF6B35;
            margin-bottom: 20px;
        }

        .greeting-card .message {
            color: #333;
            font-size: 16px;
            line-height: 2;
            text-align: left;
            white-space: pre-line;
        }

        .greeting-card .signature {
            margin-top: 30px;
            font-style: italic;
            color: #666;
        }

        /* å†çœ‹ä¸€éæŒ‰é’® */
        .replay-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #FF6B35 0%, #ff4500 100%);
            border: none;
            border-radius: 30px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .replay-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        .tagline {
            margin-top: 20px;
            font-size: 14px;
            color: #999;
        }

        /* éŸ³é¢‘æ§åˆ¶ */
        .audio-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 107, 53, 0.8);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            z-index: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .audio-control:hover {
            transform: scale(1.1);
        }

        /* å¼€å§‹æŒ‰é’® */
        .start-btn {
            padding: 20px 60px;
            background: linear-gradient(135deg, #FF6B35 0%, #ff4500 100%);
            border: none;
            border-radius: 40px;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: breathe 2s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 53, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 107, 53, 0.8); }
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* å›å¿†å¡ç‰‡ */
        .memory-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            padding: 20px;
            z-index: 10;
        }

        .memory-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            width: 200px;
            text-align: center;
            opacity: 0;
            transform: translateY(30px);
            animation: cardSlideIn 0.8s ease forwards;
        }

        .memory-card:nth-child(1) { animation-delay: 0.2s; }
        .memory-card:nth-child(2) { animation-delay: 0.4s; }
        .memory-card:nth-child(3) { animation-delay: 0.6s; }
        .memory-card:nth-child(4) { animation-delay: 0.8s; }

        @keyframes cardSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .memory-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid #FF6B35;
        }

        .memory-card p {
            font-size: 14px;
            color: #fceea7;
            line-height: 1.6;
        }

        /* å¹´é¾„æ•°å­—åŠ¨ç”» */
        .age-number {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 120px;
            color: #FFD700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: ageGlow 2s ease-in-out infinite alternate;
        }

        @keyframes ageGlow {
            0% { text-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            100% { text-shadow: 0 0 60px rgba(255, 215, 0, 1); }
        }

        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .cake {
                width: 220px;
                height: 160px;
            }
            
            .cake-layer-1 {
                width: 200px;
                height: 60px;
            }
            
            .cake-layer-2 {
                bottom: 50px;
                width: 160px;
                height: 55px;
            }
            
            .cake-layer-3 {
                bottom: 95px;
                width: 120px;
                height: 50px;
            }
            
            .candle-photos {
                top: -150px;
                width: 260px;
                height: 160px;
            }
            
            .greeting-card {
                padding: 25px;
            }
            
            .greeting-card h2 {
                font-size: 28px;
            }
            
            .greeting-card .message {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é¡µé¢ -->
    <div id="loader">
        <div class="spinner"></div>
        <p class="loader-text">æ­£åœ¨å‡†å¤‡æƒŠå–œ...</p>
    </div>

    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <canvas id="starfield"></canvas>
    
    <!-- ç«èŠ±ç”»å¸ƒ -->
    <canvas id="spark-canvas"></canvas>
    
    <!-- çƒŸèŠ±ç”»å¸ƒ -->
    <canvas id="firework-canvas"></canvas>

    <!-- åœºæ™¯1: åºå¹• - å¼€å§‹é¡µé¢ -->
    <div id="intro-scene" class="scene active">
        <div class="spark"></div>
        <h1 class="scene-text" style="margin-top: 30px;">ç«èŠ±ç›¸é‡ï¼ŒçƒŸèŠ±ç»½æ”¾</h1>
        <p class="scene-subtext">ä¸ºæ†¨é¥±é¥±å‡†å¤‡çš„ç”Ÿæ—¥æƒŠå–œ</p>
        <button class="start-btn" onclick="startExperience()">ç‚¹å‡»å¼€å§‹</button>
    </div>

    <!-- åœºæ™¯2: ç«èŠ±äº®èµ· -->
    <div id="spark-scene" class="scene">
        <div class="spark" id="main-spark"></div>
        <h1 class="scene-text">åŠå¹´å‰</h1>
        <p class="scene-subtext">ç«èŠ±ä¸Šå¤šäº†ä¸€ä¸ªæœ‹å‹</p>
    </div>

    <!-- åœºæ™¯3: ç¬¬ä¸€æ¬¡ç›¸é‡ -->
    <div id="meeting-scene" class="scene">
        <img src="images/first_meeting.jpg" alt="ç¬¬ä¸€æ¬¡ç›¸é‡" style="max-width: 80%; max-height: 50vh; border-radius: 15px; box-shadow: 0 10px 40px rgba(255, 107, 53, 0.4); z-index: 10;">
        <h1 class="scene-text" style="margin-top: 30px;">è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡ç›¸é‡</h1>
    </div>

    <!-- åœºæ™¯4: çƒŸèŠ±ç»½æ”¾ -->
    <div id="firework-scene" class="scene">
        <h1 class="scene-text">ä»Šå¤©ï¼Œç«èŠ±å˜æˆçƒŸèŠ±</h1>
        <p class="scene-subtext">ä¸ºä½ ç»½æ”¾</p>
    </div>

    <!-- åœºæ™¯5: å›å¿†ç‰‡æ®µ -->
    <div id="memory-scene" class="scene">
        <h1 class="scene-text" style="margin-bottom: 30px;">è¿™åŠå¹´</h1>
        <div class="memory-cards">
            <div class="memory-card">
                <img src="images/dog1.jpg" alt="é…±è‚‰åŒ…">
                <p>ç¬¬ä¸€æ¬¡èŠå¤©<br>æ²¡æƒ³åˆ°èƒ½èŠè¿™ä¹ˆä¹…</p>
            </div>
            <div class="memory-card">
                <img src="images/dog2.jpg" alt="å›å¿†2">
                <p>åˆ†äº«æ—¥å¸¸<br>åæ§½ç”Ÿæ´»</p>
            </div>
            <div class="memory-card">
                <img src="images/sunset.jpg" alt="å›å¿†3">
                <p>å¤‡è€ƒçš„æ—¶å€™<br>äº’ç›¸æ‰“æ°”</p>
            </div>
            <div class="memory-card">
                <img src="images/cat.jpg" alt="å›å¿†4">
                <p>è®¤è¯†ä½ <br>æŒºå¥½çš„</p>
            </div>
        </div>
    </div>

    <!-- åœºæ™¯6: ç”Ÿæ—¥è›‹ç³• - å¹èœ¡çƒ› -->
    <div id="cake-scene" class="scene">
        <h1 class="scene-text" style="margin-bottom: 20px;">è®¸ä¸ªæ„¿å§ï¼Œæ†¨é¥±é¥±</h1>
        <div class="age-number">24</div>
        <div class="cake-container">
            <div class="candle-photos" id="candle-photos">
                <!-- ç…§ç‰‡èœ¡çƒ›å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="cake">
                <div class="cake-layer cake-layer-3"></div>
                <div class="cake-layer cake-layer-2"></div>
                <div class="cake-layer cake-layer-1"></div>
            </div>
        </div>
        <p class="blow-hint" id="blow-hint">ç‚¹å‡»èœ¡çƒ›å¹ç­å®ƒä»¬</p>
    </div>

    <!-- åœºæ™¯7: è´ºå¡ç¥ç¦ -->
    <div id="card-scene" class="scene">
        <div class="greeting-card">
            <img src="images/avatar.png" alt="æ†¨é¥±é¥±" class="avatar">
            <h2>ç”Ÿæ—¥å¿«ä¹ï¼</h2>
            <div class="message">
æ†¨é¥±é¥±ï¼ˆå¼ ç‰ï¼‰ï¼š

ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚

è®¤è¯†åŠå¹´äº†ï¼Œæ—¶é—´è¿‡å¾—æŒºå¿«çš„ã€‚
ä»ç«èŠ±ä¸Šçš„ä¸€å¥"Hi~"å¼€å§‹ï¼Œ
åˆ°ç°åœ¨å¯ä»¥èŠå¾ˆä¹…å¾ˆä¹…ã€‚

çŸ¥é“ä½ æ¯å¤©å­¦ä¹ å¾ˆåŠªåŠ›ï¼Œ
æœ‰æ—¶å€™15ä¸ªå°æ—¶ç”šè‡³æ›´å¤šï¼Œ
çœŸçš„å¾ˆä½©æœä½ ï¼

æ–°çš„ä¸€å²ï¼Œç¥ä½ ï¼š
âœ¨ è€ƒç ”é¡ºåˆ©ï¼ŒæˆåŠŸä¸Šå²¸
âœ¨ è€ƒç¼–é¡ºåˆ©ï¼Œå¿ƒæƒ³äº‹æˆ
âœ¨ é…±è‚‰åŒ…å¥åº·å¯çˆ±
âœ¨ å¤©å¤©å¼€å¿ƒï¼Œä¸€åˆ‡éƒ½å¥½

åŠ æ²¹ï¼æˆ‘ä»¬ç»§ç»­ä¸€èµ·æ‰“æ°”ï¼

â€”â€” ä½ çš„ç«èŠ±å¥½å‹
            </div>
            <button class="replay-btn" onclick="replay()">å†çœ‹ä¸€é</button>
            <p class="tagline">ç«èŠ±ç›¸é‡ï¼ŒçƒŸèŠ±ç»½æ”¾ âœ¨</p>
        </div>
    </div>

    <!-- ç…§ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div class="photo-modal" id="photo-modal">
        <button class="close-btn" onclick="closePhotoModal()">Ã—</button>
        <img id="modal-image" src="" alt="æ”¾å¤§ç…§ç‰‡">
    </div>

    <!-- éŸ³é¢‘æ§åˆ¶ -->
    <button class="audio-control" id="audio-btn" onclick="toggleAudio()">ğŸ”Š</button>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-sleepy-cat-135.mp3" type="audio/mpeg">
    </audio>

    <script>
        // å…¨å±€å˜é‡
        let currentScene = 0;
        const scenes = ['intro-scene', 'spark-scene', 'meeting-scene', 'firework-scene', 'memory-scene', 'cake-scene', 'card-scene'];
        let audioPlaying = false;
        let candlesBlown = 0;
        const totalCandles = 8;

        // ç…§ç‰‡åˆ—è¡¨
        const photos = [
            'images/memory1.jpg',
            'images/memory2.jpg',
            'images/memory3.jpg',
            'images/memory4.jpg',
            'images/memory5.jpg',
            'images/memory6.jpg',
            'images/memory7.jpg',
            'images/memory8.jpg'
        ];

        // åˆå§‹åŒ–
        window.onload = function() {
            initStarfield();
            initCandlePhotos();
            
            // éšè—åŠ è½½é¡µé¢
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
            }, 1500);
        };

        // æ˜Ÿç©ºèƒŒæ™¯
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const stars = [];
            for (let i = 0; i < 200; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    opacity: Math.random(),
                    speed: Math.random() * 0.02
                });
            }

            function drawStars() {
                ctx.fillStyle = '#0A1628';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                stars.forEach(star => {
                    star.opacity += star.speed;
                    if (star.opacity > 1 || star.opacity < 0) star.speed *= -1;

                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fill();
                });

                requestAnimationFrame(drawStars);
            }

            drawStars();

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // åˆå§‹åŒ–èœ¡çƒ›ç…§ç‰‡
        function initCandlePhotos() {
            const container = document.getElementById('candle-photos');
            const positions = [
                { left: '10%', top: '20%', width: '50px', height: '60px', rotate: -10 },
                { left: '30%', top: '5%', width: '55px', height: '65px', rotate: 5 },
                { left: '50%', top: '15%', width: '45px', height: '55px', rotate: -5 },
                { left: '70%', top: '0%', width: '50px', height: '60px', rotate: 8 },
                { left: '5%', top: '50%', width: '48px', height: '58px', rotate: -8 },
                { left: '25%', top: '40%', width: '52px', height: '62px', rotate: 3 },
                { left: '55%', top: '45%', width: '46px', height: '56px', rotate: -3 },
                { left: '75%', top: '35%', width: '50px', height: '60px', rotate: 6 }
            ];

            photos.forEach((photo, index) => {
                const candle = document.createElement('div');
                candle.className = 'photo-candle';
                candle.style.left = positions[index].left;
                candle.style.top = positions[index].top;
                candle.style.width = positions[index].width;
                candle.style.height = positions[index].height;
                candle.style.transform = `rotate(${positions[index].rotate}deg)`;
                candle.dataset.index = index;

                candle.innerHTML = `
                    <img src="${photo}" alt="ç…§ç‰‡${index + 1}">
                    <div class="flame"></div>
                `;

                candle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!candle.classList.contains('blown')) {
                        blowCandle(candle);
                    } else {
                        openPhotoModal(photo);
                    }
                });

                container.appendChild(candle);
            });
        }

        // å¹ç­èœ¡çƒ›
        function blowCandle(candle) {
            candle.classList.add('blown');
            candlesBlown++;

            // æ’­æ”¾å°çƒŸèŠ±æ•ˆæœ
            createMiniFirework(candle);

            if (candlesBlown >= totalCandles) {
                document.getElementById('blow-hint').textContent = 'æ„¿æœ›ä¼šå®ç°çš„ âœ¨ ç‚¹å‡»ç…§ç‰‡å¯ä»¥æ”¾å¤§æŸ¥çœ‹';
                setTimeout(() => {
                    goToScene(6); // è·³è½¬åˆ°è´ºå¡åœºæ™¯
                }, 3000);
            }
        }

        // å°çƒŸèŠ±æ•ˆæœ
        function createMiniFirework(element) {
            const rect = element.getBoundingClientRect();
            const canvas = document.getElementById('firework-canvas');
            const ctx = canvas.getContext('2d');
            
            const particles = [];
            const colors = ['#FFD700', '#FF6B35', '#FF7F7F', '#4A90D9'];
            
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: rect.left + rect.width / 2,
                    y: rect.top,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8 - 3,
                    radius: Math.random() * 3 + 1,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    life: 1
                });
            }

            function animate() {
                particles.forEach((p, index) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1;
                    p.life -= 0.02;

                    if (p.life > 0) {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        ctx.fillStyle = p.color;
                        ctx.globalAlpha = p.life;
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                });

                const alive = particles.filter(p => p.life > 0);
                if (alive.length > 0) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        // æ‰“å¼€ç…§ç‰‡æ¨¡æ€æ¡†
        function openPhotoModal(src) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('modal-image');
            img.src = src;
            modal.classList.add('active');
        }

        // å…³é—­ç…§ç‰‡æ¨¡æ€æ¡†
        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
        }

        // å¼€å§‹ä½“éªŒ
        function startExperience() {
            playAudio();
            goToScene(1);
            
            // è‡ªåŠ¨æ’­æ”¾åœºæ™¯
            setTimeout(() => goToScene(2), 6000);
            setTimeout(() => goToScene(3), 12000);
            setTimeout(() => {
                startFireworks();
            }, 12500);
            setTimeout(() => goToScene(4), 24000);
            setTimeout(() => goToScene(5), 38000);
        }

        // åˆ‡æ¢åœºæ™¯
        function goToScene(index) {
            scenes.forEach((scene, i) => {
                const el = document.getElementById(scene);
                if (i === index) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
            currentScene = index;
        }

        // çƒŸèŠ±æ•ˆæœ
        function startFireworks() {
            const canvas = document.getElementById('firework-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const fireworks = [];
            const particles = [];
            const colors = ['#FFD700', '#FF6B35', '#FF7F7F', '#4A90D9', '#fceea7'];

            class Firework {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height;
                    this.targetY = Math.random() * canvas.height * 0.5;
                    this.speed = 8 + Math.random() * 4;
                    this.exploded = false;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                }

                update() {
                    if (!this.exploded) {
                        this.y -= this.speed;
                        if (this.y <= this.targetY) {
                            this.explode();
                        }
                    }
                }

                draw() {
                    if (!this.exploded) {
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                        ctx.fillStyle = this.color;
                        ctx.fill();
                    }
                }

                explode() {
                    this.exploded = true;
                    for (let i = 0; i < 80; i++) {
                        const angle = (Math.PI * 2 / 80) * i;
                        const speed = 2 + Math.random() * 4;
                        particles.push({
                            x: this.x,
                            y: this.y,
                            vx: Math.cos(angle) * speed,
                            vy: Math.sin(angle) * speed,
                            radius: 2 + Math.random() * 2,
                            color: this.color,
                            life: 1,
                            decay: 0.01 + Math.random() * 0.01
                        });
                    }
                }
            }

            let frameCount = 0;
            const duration = 10000; // 10ç§’çƒŸèŠ±
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                if (elapsed > duration) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    return;
                }

                ctx.fillStyle = 'rgba(10, 22, 40, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // æ·»åŠ æ–°çƒŸèŠ±
                if (frameCount % 30 === 0) {
                    fireworks.push(new Firework());
                }

                // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
                fireworks.forEach((fw, index) => {
                    fw.update();
                    fw.draw();
                    if (fw.exploded) {
                        fireworks.splice(index, 1);
                    }
                });

                // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
                particles.forEach((p, index) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.05;
                    p.life -= p.decay;

                    if (p.life <= 0) {
                        particles.splice(index, 1);
                    } else {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius * p.life, 0, Math.PI * 2);
                        ctx.fillStyle = p.color;
                        ctx.globalAlpha = p.life;
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                });

                frameCount++;
                requestAnimationFrame(animate);
            }

            animate();
        }

        // éŸ³é¢‘æ§åˆ¶
        function playAudio() {
            const audio = document.getElementById('bgm');
            audio.volume = 0.3;
            audio.play().catch(() => {});
            audioPlaying = true;
            document.getElementById('audio-btn').textContent = 'ğŸ”Š';
        }

        function toggleAudio() {
            const audio = document.getElementById('bgm');
            if (audioPlaying) {
                audio.pause();
                document.getElementById('audio-btn').textContent = 'ğŸ”‡';
            } else {
                audio.play();
                document.getElementById('audio-btn').textContent = 'ğŸ”Š';
            }
            audioPlaying = !audioPlaying;
        }

        // é‡æ–°æ’­æ”¾
        function replay() {
            candlesBlown = 0;
            document.querySelectorAll('.photo-candle').forEach(candle => {
                candle.classList.remove('blown');
            });
            document.getElementById('blow-hint').textContent = 'ç‚¹å‡»èœ¡çƒ›å¹ç­å®ƒä»¬';
            goToScene(0);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('photo-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('photo-modal')) {
                closePhotoModal();
            }
        });

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePhotoModal();
            }
        });

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            const fireworkCanvas = document.getElementById('firework-canvas');
            fireworkCanvas.width = window.innerWidth;
            fireworkCanvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
